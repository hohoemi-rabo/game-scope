# ãƒã‚±ãƒƒãƒˆ #21: ç·¨é›†å‰Šé™¤æ©Ÿèƒ½

## ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: [å®Œäº†]

## æ¦‚è¦

ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç™»éŒ²æ¸ˆã¿ã®ã‚²ãƒ¼ãƒ ã‚’ç·¨é›†ãƒ»å‰Šé™¤ã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚

## èƒŒæ™¯

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ¬ã‚¤æ™‚é–“ã‚„è³¼å…¥é‡‘é¡ã‚’æ›´æ–°ã—ãŸã„å ´åˆãŒã‚ã‚‹
- é–“é•ã£ã¦ç™»éŒ²ã—ãŸã‚²ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ãŸã„å ´åˆãŒã‚ã‚‹
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ï¼ˆãƒ—ãƒ¬ã‚¤ä¸­â†’ã‚¯ãƒªã‚¢æ¸ˆã¿ç­‰ï¼‰ã®ãƒ‹ãƒ¼ã‚ºãŒã‚ã‚‹

## ä½œæ¥­å†…å®¹

### 1. ç·¨é›†æ©Ÿèƒ½

- [x] ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ
- [x] æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ãƒ—ãƒªãƒ•ã‚£ãƒ«
- [x] `updatePortfolioEntry` Server Actionå®Ÿè£…
- [x] æ¥½è¦³çš„UIæ›´æ–°ï¼ˆä»»æ„ï¼‰â†’ router.refresh()ã§å¯¾å¿œ

### 2. å‰Šé™¤æ©Ÿèƒ½

- [x] å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
- [x] `deletePortfolioEntry` Server Actionå®Ÿè£…
- [x] å‰Šé™¤å¾Œã®ãƒªã‚¹ãƒˆæ›´æ–°

### 3. GameListã¨ã®é€£æº

- [x] ç·¨é›†ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
- [x] å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
- [x] æ“ä½œå®Œäº†å¾Œã®UIæ›´æ–°

## æŠ€è¡“ä»•æ§˜

### ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«

```typescript
// src/app/components/portfolio/EditGameModal.tsx
'use client'

import { useState } from 'react'
import { updatePortfolioEntry } from '@/app/actions/portfolio'
import type { PortfolioWithGame } from '@/types/portfolio'

interface EditGameModalProps {
  portfolio: PortfolioWithGame
  isOpen: boolean
  onClose: () => void
  onSuccess: () => void
}

type GameStatus = 'playing' | 'completed' | 'dropped' | 'backlog'

export default function EditGameModal({
  portfolio,
  isOpen,
  onClose,
  onSuccess,
}: EditGameModalProps) {
  const [purchasePrice, setPurchasePrice] = useState(portfolio.purchase_price.toString())
  const [playTimeHours, setPlayTimeHours] = useState(
    (portfolio.play_time_minutes / 60).toString()
  )
  const [isSubscription, setIsSubscription] = useState(portfolio.is_subscription)
  const [status, setStatus] = useState<GameStatus>(portfolio.status as GameStatus)
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [error, setError] = useState<string | null>(null)

  if (!isOpen) return null

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsSubmitting(true)
    setError(null)

    try {
      const result = await updatePortfolioEntry({
        id: portfolio.id,
        purchasePrice: isSubscription ? 0 : parseInt(purchasePrice) || 0,
        playTimeMinutes: Math.round((parseFloat(playTimeHours) || 0) * 60),
        isSubscription,
        status,
      })

      if (result.error) {
        setError(result.error)
      } else {
        onSuccess()
        onClose()
      }
    } catch (err) {
      setError('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ')
    } finally {
      setIsSubmitting(false)
    }
  }

  const game = portfolio.games

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      {/* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */}
      <div
        className="absolute inset-0 bg-black/70"
        onClick={onClose}
      />

      {/* ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬ä½“ */}
      <div className="relative w-full max-w-md bg-gray-900 border border-gray-700
                      rounded-xl p-6 shadow-xl">
        <h2 className="text-xl font-bold text-text-primary mb-6">
          ã‚²ãƒ¼ãƒ æƒ…å ±ã‚’ç·¨é›†
        </h2>

        <form onSubmit={handleSubmit} className="space-y-6">
          {/* ã‚²ãƒ¼ãƒ æƒ…å ±è¡¨ç¤º */}
          <div className="flex items-center gap-4">
            {game.thumbnail_url && (
              <img
                src={game.thumbnail_url}
                alt={game.title_ja || game.title_en}
                className="w-20 h-12 object-cover rounded"
              />
            )}
            <h3 className="font-bold text-text-primary">
              {game.title_ja || game.title_en}
            </h3>
          </div>

          {/* è³¼å…¥é‡‘é¡ */}
          <div>
            <label className="block text-sm font-medium text-text-secondary mb-2">
              è³¼å…¥é‡‘é¡
            </label>
            <div className="flex items-center gap-2">
              <span className="text-text-secondary">Â¥</span>
              <input
                type="number"
                value={purchasePrice}
                onChange={(e) => setPurchasePrice(e.target.value)}
                disabled={isSubscription}
                placeholder="9000"
                className="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-4 py-2
                           text-text-primary focus:border-accent focus:outline-none
                           disabled:opacity-50"
              />
            </div>
            <label className="flex items-center gap-2 mt-2">
              <input
                type="checkbox"
                checked={isSubscription}
                onChange={(e) => setIsSubscription(e.target.checked)}
                className="rounded border-gray-700"
              />
              <span className="text-sm text-text-secondary">ã‚µãƒ–ã‚¹ã‚¯/ç„¡æ–™ã§å…¥æ‰‹</span>
            </label>
          </div>

          {/* ãƒ—ãƒ¬ã‚¤æ™‚é–“ */}
          <div>
            <label className="block text-sm font-medium text-text-secondary mb-2">
              ãƒ—ãƒ¬ã‚¤æ™‚é–“
            </label>
            <div className="flex items-center gap-2">
              <input
                type="number"
                step="0.5"
                value={playTimeHours}
                onChange={(e) => setPlayTimeHours(e.target.value)}
                placeholder="120"
                className="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-4 py-2
                           text-text-primary focus:border-accent focus:outline-none"
              />
              <span className="text-text-secondary">æ™‚é–“</span>
            </div>
          </div>

          {/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */}
          <div>
            <label className="block text-sm font-medium text-text-secondary mb-2">
              ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
            </label>
            <select
              value={status}
              onChange={(e) => setStatus(e.target.value as GameStatus)}
              className="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2
                         text-text-primary focus:border-accent focus:outline-none"
            >
              <option value="playing">ğŸ® Playingï¼ˆãƒ—ãƒ¬ã‚¤ä¸­ï¼‰</option>
              <option value="completed">âœ… Completedï¼ˆã‚¯ãƒªã‚¢æ¸ˆã¿ï¼‰</option>
              <option value="dropped">âŒ Droppedï¼ˆã‚„ã‚ãŸï¼‰</option>
              <option value="backlog">ğŸ“š Backlogï¼ˆç©ã¿ã‚²ãƒ¼ï¼‰</option>
            </select>
          </div>

          {/* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */}
          {error && (
            <div className="text-danger text-sm">{error}</div>
          )}

          {/* ãƒœã‚¿ãƒ³ */}
          <div className="flex gap-4">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 px-4 py-2 border border-gray-700 rounded-lg
                         text-text-secondary hover:bg-gray-800 transition-colors"
            >
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button
              type="submit"
              disabled={isSubmitting}
              className="flex-1 px-4 py-2 bg-accent text-white rounded-lg
                         hover:bg-accent/80 transition-colors disabled:opacity-50"
            >
              {isSubmitting ? 'æ›´æ–°ä¸­...' : 'æ›´æ–°ã™ã‚‹'}
            </button>
          </div>
        </form>
      </div>
    </div>
  )
}
```

### å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°

```typescript
// src/app/components/portfolio/DeleteConfirmDialog.tsx
'use client'

import { useState } from 'react'
import { deletePortfolioEntry } from '@/app/actions/portfolio'

interface DeleteConfirmDialogProps {
  portfolioId: string
  gameName: string
  isOpen: boolean
  onClose: () => void
  onSuccess: () => void
}

export default function DeleteConfirmDialog({
  portfolioId,
  gameName,
  isOpen,
  onClose,
  onSuccess,
}: DeleteConfirmDialogProps) {
  const [isDeleting, setIsDeleting] = useState(false)
  const [error, setError] = useState<string | null>(null)

  if (!isOpen) return null

  const handleDelete = async () => {
    setIsDeleting(true)
    setError(null)

    try {
      const result = await deletePortfolioEntry(portfolioId)

      if (result.error) {
        setError(result.error)
      } else {
        onSuccess()
        onClose()
      }
    } catch (err) {
      setError('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ')
    } finally {
      setIsDeleting(false)
    }
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      {/* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */}
      <div
        className="absolute inset-0 bg-black/70"
        onClick={onClose}
      />

      {/* ãƒ€ã‚¤ã‚¢ãƒ­ã‚°æœ¬ä½“ */}
      <div className="relative w-full max-w-sm bg-gray-900 border border-gray-700
                      rounded-xl p-6 shadow-xl">
        <h2 className="text-xl font-bold text-text-primary mb-4">
          ã‚²ãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ
        </h2>

        <p className="text-text-secondary mb-6">
          ã€Œ<span className="text-text-primary font-medium">{gameName}</span>ã€
          ã‚’ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
        </p>

        {/* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */}
        {error && (
          <div className="text-danger text-sm mb-4">{error}</div>
        )}

        {/* ãƒœã‚¿ãƒ³ */}
        <div className="flex gap-4">
          <button
            type="button"
            onClick={onClose}
            disabled={isDeleting}
            className="flex-1 px-4 py-2 border border-gray-700 rounded-lg
                       text-text-secondary hover:bg-gray-800 transition-colors
                       disabled:opacity-50"
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button
            type="button"
            onClick={handleDelete}
            disabled={isDeleting}
            className="flex-1 px-4 py-2 bg-danger text-white rounded-lg
                       hover:bg-danger/80 transition-colors disabled:opacity-50"
          >
            {isDeleting ? 'å‰Šé™¤ä¸­...' : 'å‰Šé™¤ã™ã‚‹'}
          </button>
        </div>
      </div>
    </div>
  )
}
```

### Server Actions

```typescript
// src/app/actions/portfolio.ts ã«è¿½åŠ 

interface UpdatePortfolioInput {
  id: string
  purchasePrice: number
  playTimeMinutes: number
  isSubscription: boolean
  status: 'playing' | 'completed' | 'dropped' | 'backlog'
}

export async function updatePortfolioEntry(input: UpdatePortfolioInput) {
  const supabase = createClient()

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ç¢ºèª
  const { data: { user }, error: authError } = await supabase.auth.getUser()

  if (authError || !user) {
    return { error: 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™' }
  }

  // æ‰€æœ‰è€…ç¢ºèª
  const { data: existing } = await supabase
    .from('user_portfolios')
    .select('id, user_id')
    .eq('id', input.id)
    .single()

  if (!existing || existing.user_id !== user.id) {
    return { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' }
  }

  // æ›´æ–°å®Ÿè¡Œ
  const { error } = await supabase
    .from('user_portfolios')
    .update({
      purchase_price: input.purchasePrice,
      play_time_minutes: input.playTimeMinutes,
      is_subscription: input.isSubscription,
      status: input.status,
      updated_at: new Date().toISOString(),
    })
    .eq('id', input.id)

  if (error) {
    console.error('Portfolio update error:', error)
    return { error: 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' }
  }

  revalidatePath('/dashboard')

  return { success: true }
}

export async function deletePortfolioEntry(portfolioId: string) {
  const supabase = createClient()

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ç¢ºèª
  const { data: { user }, error: authError } = await supabase.auth.getUser()

  if (authError || !user) {
    return { error: 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™' }
  }

  // æ‰€æœ‰è€…ç¢ºèª
  const { data: existing } = await supabase
    .from('user_portfolios')
    .select('id, user_id')
    .eq('id', portfolioId)
    .single()

  if (!existing || existing.user_id !== user.id) {
    return { error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' }
  }

  // å‰Šé™¤å®Ÿè¡Œ
  const { error } = await supabase
    .from('user_portfolios')
    .delete()
    .eq('id', portfolioId)

  if (error) {
    console.error('Portfolio deletion error:', error)
    return { error: 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ' }
  }

  revalidatePath('/dashboard')

  return { success: true }
}
```

### GameList ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆæ›´æ–°ç‰ˆï¼‰

```typescript
// src/app/components/dashboard/GameList.tsx
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import GameListItem from './GameListItem'
import EditGameModal from '../portfolio/EditGameModal'
import DeleteConfirmDialog from '../portfolio/DeleteConfirmDialog'
import type { PortfolioWithGame } from '@/types/portfolio'

interface GameListProps {
  portfolios: PortfolioWithGame[]
}

export default function GameList({ portfolios }: GameListProps) {
  const router = useRouter()
  const [editingPortfolio, setEditingPortfolio] = useState<PortfolioWithGame | null>(null)
  const [deletingPortfolio, setDeletingPortfolio] = useState<PortfolioWithGame | null>(null)

  const handleEditSuccess = () => {
    setEditingPortfolio(null)
    router.refresh()
  }

  const handleDeleteSuccess = () => {
    setDeletingPortfolio(null)
    router.refresh()
  }

  if (portfolios.length === 0) {
    return (
      <div className="text-center py-12">
        <span className="text-4xl mb-4 block">ğŸ®</span>
        <p className="text-text-secondary">
          ã¾ã ã‚²ãƒ¼ãƒ ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
        </p>
        <p className="text-text-secondary text-sm mt-2">
          ã€Œ+ ã‚²ãƒ¼ãƒ ã‚’ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ï¼
        </p>
      </div>
    )
  }

  return (
    <>
      <div className="space-y-4">
        {portfolios.map((portfolio) => (
          <GameListItem
            key={portfolio.id}
            portfolio={portfolio}
            onEdit={() => setEditingPortfolio(portfolio)}
            onDelete={() => setDeletingPortfolio(portfolio)}
          />
        ))}
      </div>

      {/* ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {editingPortfolio && (
        <EditGameModal
          portfolio={editingPortfolio}
          isOpen={!!editingPortfolio}
          onClose={() => setEditingPortfolio(null)}
          onSuccess={handleEditSuccess}
        />
      )}

      {/* å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° */}
      {deletingPortfolio && (
        <DeleteConfirmDialog
          portfolioId={deletingPortfolio.id}
          gameName={deletingPortfolio.games.title_ja || deletingPortfolio.games.title_en}
          isOpen={!!deletingPortfolio}
          onClose={() => setDeletingPortfolio(null)}
          onSuccess={handleDeleteSuccess}
        />
      )}
    </>
  )
}
```

## ä¾å­˜é–¢ä¿‚

- #16 DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- #17 èªè¨¼UIå®Ÿè£…
- #19 ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªç™»éŒ²æ©Ÿèƒ½
- #20 ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰UI

## å—ã‘å…¥ã‚Œæ¡ä»¶

- [x] ç·¨é›†ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã
- [x] æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ—ãƒªãƒ•ã‚£ãƒ«ã•ã‚Œã¦ã„ã‚‹
- [x] è³¼å…¥é‡‘é¡ã€ãƒ—ãƒ¬ã‚¤æ™‚é–“ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´ã§ãã‚‹
- [x] æ›´æ–°å¾Œã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«åæ˜ ã•ã‚Œã‚‹
- [x] å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [x] å‰Šé™¤å¾Œã€ã‚²ãƒ¼ãƒ ãŒãƒªã‚¹ãƒˆã‹ã‚‰æ¶ˆãˆã‚‹
- [x] ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã¯ç·¨é›†ãƒ»å‰Šé™¤ã§ããªã„ï¼ˆRLSï¼‰
- [x] æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯æ“ä½œã§ããªã„ï¼ˆã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼‰

## ãƒ‡ã‚¶ã‚¤ãƒ³ä»•æ§˜

- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«: ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã¨åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«
- å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°: èµ¤è‰²ã®å‰Šé™¤ãƒœã‚¿ãƒ³
- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹: ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦ã€Œå‡¦ç†ä¸­...ã€è¡¨ç¤º
- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º: èµ¤è‰²ãƒ†ã‚­ã‚¹ãƒˆã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥

## é–¢é€£ãƒã‚±ãƒƒãƒˆ

- #19 ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªç™»éŒ²æ©Ÿèƒ½
- #20 ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰UI
