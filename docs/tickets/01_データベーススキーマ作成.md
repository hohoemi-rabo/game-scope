# 01_データベーススキーマ作成

**ステータス**: [未着手]
**優先度**: 高
**Phase**: Phase 1 (MVP)

## 概要

Supabase PostgreSQL データベースに、ゲーム情報を格納するためのテーブルスキーマを作成する。

## 目的

- ゲーム情報を格納する `games` テーブルの作成
- Twitch 連携情報を格納する `twitch_links` テーブルの作成
- 発売予定情報を格納する `releases` テーブルの作成
- 操作ログを記録する `operation_logs` テーブルの作成

## タスク一覧

### 1. マイグレーションファイルの作成
- [ ] Supabase CLI でマイグレーション初期化
- [ ] `games` テーブルのマイグレーションファイル作成
- [ ] `twitch_links` テーブルのマイグレーションファイル作成
- [ ] `releases` テーブルのマイグレーションファイル作成
- [ ] `operation_logs` テーブルのマイグレーションファイル作成

### 2. テーブル定義の実装
- [ ] games テーブル作成
- [ ] twitch_links テーブル作成
- [ ] releases テーブル作成
- [ ] operation_logs テーブル作成

### 3. インデックスの作成
- [ ] games テーブルに必要なインデックスを追加
  - `opencritic_id` (UNIQUE)
  - `metascore` (検索用)
  - `release_date` (ソート用)
- [ ] twitch_links テーブルに `game_id` インデックス追加

### 4. Row Level Security (RLS) の設定
- [ ] games テーブルに RLS ポリシー設定（読み取り専用）
- [ ] twitch_links テーブルに RLS ポリシー設定
- [ ] releases テーブルに RLS ポリシー設定
- [ ] operation_logs テーブルに RLS ポリシー設定

### 5. マイグレーションの実行と確認
- [ ] ローカル環境でマイグレーション実行
- [ ] Supabase ダッシュボードでテーブル確認
- [ ] テーブル構造のドキュメント化

## 実装詳細

### SQL スキーマ（REQUIREMENTS.md より）

```sql
-- ゲーム情報
CREATE TABLE games (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  title_ja TEXT,
  title_en TEXT NOT NULL,
  platforms TEXT[],
  metascore INTEGER,
  review_count INTEGER,
  release_date DATE,
  thumbnail_url TEXT,
  opencritic_id TEXT UNIQUE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_games_metascore ON games(metascore DESC);
CREATE INDEX idx_games_release_date ON games(release_date DESC);
CREATE INDEX idx_games_opencritic_id ON games(opencritic_id);

-- Twitch連携情報
CREATE TABLE twitch_links (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  game_id UUID REFERENCES games(id) ON DELETE CASCADE,
  clip_url TEXT,
  thumbnail_url TEXT,
  has_live BOOLEAN DEFAULT false,
  viewer_count INTEGER,
  checked_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_twitch_links_game_id ON twitch_links(game_id);

-- 発売予定情報
CREATE TABLE releases (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  title TEXT NOT NULL,
  platform TEXT,
  release_date DATE,
  source TEXT,
  link_url TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_releases_date ON releases(release_date ASC);

-- 操作ログ
CREATE TABLE operation_logs (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  operation_type TEXT,
  status TEXT,
  details JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_operation_logs_created_at ON operation_logs(created_at DESC);
```

### Row Level Security ポリシー

```sql
-- games テーブル: 全ユーザーが読み取り可能
ALTER TABLE games ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow public read access" ON games
  FOR SELECT
  USING (true);

-- twitch_links テーブル: 全ユーザーが読み取り可能
ALTER TABLE twitch_links ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow public read access" ON twitch_links
  FOR SELECT
  USING (true);

-- releases テーブル: 全ユーザーが読み取り可能
ALTER TABLE releases ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow public read access" ON releases
  FOR SELECT
  USING (true);

-- operation_logs: サービスロールのみアクセス可能
ALTER TABLE operation_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Service role only" ON operation_logs
  USING (auth.role() = 'service_role');
```

## 完了条件

- [ ] すべてのテーブルが正しく作成されている
- [ ] インデックスが適切に設定されている
- [ ] RLS ポリシーが設定され、セキュリティが確保されている
- [ ] マイグレーションファイルが Git にコミットされている
- [ ] Supabase Advisor で警告が出ていない

## 関連チケット

- 前: `00_環境セットアップ.md`
- 次: `02_Supabaseクライアント設定.md`

## 参考資料

- [Supabase Database](https://supabase.com/docs/guides/database)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)
