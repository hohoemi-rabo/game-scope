# 07_初期データ投入

**ステータス**: [完了]
**優先度**: 中
**Phase**: Phase 1 (MVP)

## 概要

Supabase データベースに初期テストデータ（ゲーム情報20件）を投入する。MVP 段階での動作確認に使用。

## 目的

- テストデータの準備
- データベースへの投入
- UI/UX の動作確認
- OpenCritic API 連携のテスト

## タスク一覧

### 1. データ収集
- [x] OpenCritic から高評価ゲーム20件のリストを取得
- [x] ゲーム情報の整理（タイトル、スコア、プラットフォームなど）
- [x] 日本語タイトルのマッピング

### 2. データ投入スクリプト作成
- [x] `scripts/seed-data.ts` の作成
- [x] Supabase クライアントの設定
- [x] データ投入ロジックの実装

### 3. データの検証
- [x] データが正しく投入されたか確認
- [x] Supabase ダッシュボードでの確認
- [x] アプリケーション上での表示確認

### 4. ドキュメント作成
- [x] データソースの記録
- [x] 投入手順のドキュメント化

## 実装詳細

### scripts/seed-data.ts

```typescript
import { createClient } from '@supabase/supabase-js'
import type { Database } from '../src/lib/supabase/types'

// Supabase クライアントの作成（サービスロールキー使用）
const supabase = createClient<Database>(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
)

/**
 * 初期ゲームデータ
 * OpenCritic の高評価ゲームから抽出
 */
const seedGames = [
  {
    title_ja: 'エルデンリング',
    title_en: 'Elden Ring',
    platforms: ['PC', 'PlayStation 5', 'Xbox Series X'],
    metascore: 96,
    review_count: 102,
    release_date: '2022-02-25',
    thumbnail_url: 'https://example.com/elden-ring.jpg',
    opencritic_id: '12345',
  },
  {
    title_ja: 'ゼルダの伝説 ティアーズ オブ ザ キングダム',
    title_en: 'The Legend of Zelda: Tears of the Kingdom',
    platforms: ['Nintendo Switch'],
    metascore: 96,
    review_count: 145,
    release_date: '2023-05-12',
    thumbnail_url: 'https://example.com/totk.jpg',
    opencritic_id: '12346',
  },
  {
    title_ja: 'バルダーズゲート3',
    title_en: 'Baldur\'s Gate 3',
    platforms: ['PC', 'PlayStation 5', 'Xbox Series X'],
    metascore: 96,
    review_count: 89,
    release_date: '2023-08-03',
    thumbnail_url: 'https://example.com/bg3.jpg',
    opencritic_id: '12347',
  },
  // ... 残り17件のデータ
]

/**
 * データベースにシードデータを投入
 */
async function seedDatabase() {
  console.log('🌱 Starting database seeding...')

  try {
    // 既存のデータをクリア（開発環境のみ）
    if (process.env.NODE_ENV === 'development') {
      console.log('🗑️  Clearing existing data...')
      const { error: deleteError } = await supabase
        .from('games')
        .delete()
        .neq('id', '00000000-0000-0000-0000-000000000000') // 全削除

      if (deleteError) {
        console.warn('Warning: Could not clear existing data:', deleteError)
      }
    }

    // ゲームデータの投入
    console.log(`📥 Inserting ${seedGames.length} games...`)
    const { data, error } = await supabase
      .from('games')
      .insert(seedGames)
      .select()

    if (error) {
      throw error
    }

    console.log(`✅ Successfully inserted ${data.length} games`)

    // 投入されたゲームの確認
    const { data: games, error: fetchError } = await supabase
      .from('games')
      .select('title_ja, title_en, metascore')
      .order('metascore', { ascending: false })
      .limit(5)

    if (fetchError) {
      throw fetchError
    }

    console.log('\n📊 Top 5 games:')
    games.forEach((game, index) => {
      console.log(`  ${index + 1}. ${game.title_ja || game.title_en} (${game.metascore})`)
    })

    console.log('\n🎉 Database seeding completed!')
  } catch (error) {
    console.error('❌ Error seeding database:', error)
    process.exit(1)
  }
}

// スクリプトの実行
seedDatabase()
```

### package.json にスクリプト追加

```json
{
  "scripts": {
    "seed": "tsx scripts/seed-data.ts",
    "seed:prod": "NODE_ENV=production tsx scripts/seed-data.ts"
  }
}
```

### 必要なパッケージのインストール

```bash
npm install -D tsx
```

### 実行方法

```bash
# 開発環境でのデータ投入（既存データをクリア）
npm run seed

# 本番環境でのデータ投入（既存データを保持）
npm run seed:prod
```

### データソース

OpenCritic から取得する高評価ゲームの例:

1. **Elden Ring** - 96点
2. **The Legend of Zelda: Tears of the Kingdom** - 96点
3. **Baldur's Gate 3** - 96点
4. **Red Dead Redemption 2** - 95点
5. **The Witcher 3: Wild Hunt** - 95点
6. **God of War (2018)** - 94点
7. **Hades** - 93点
8. **Disco Elysium** - 93点
9. **Cyberpunk 2077: Phantom Liberty** - 92点
10. **Persona 5 Royal** - 92点
11. **Stray** - 85点
12. **Hollow Knight** - 90点
13. **Celeste** - 91点
14. **Dead Cells** - 89点
15. **Sekiro: Shadows Die Twice** - 91点
16. **Ghost of Tsushima** - 88点
17. **Spider-Man 2** - 90点
18. **Alan Wake 2** - 89点
19. **Resident Evil 4 Remake** - 93点
20. **Final Fantasy XVI** - 87点

### 日本語タイトルマッピング

```typescript
const titleMapping: Record<string, string> = {
  'Elden Ring': 'エルデンリング',
  'The Legend of Zelda: Tears of the Kingdom': 'ゼルダの伝説 ティアーズ オブ ザ キングダム',
  'Baldur\'s Gate 3': 'バルダーズゲート3',
  'Red Dead Redemption 2': 'レッド・デッド・リデンプション2',
  'The Witcher 3: Wild Hunt': 'ウィッチャー3 ワイルドハント',
  // ... その他のマッピング
}
```

## 完了条件

- [x] データ投入スクリプトが正常に動作する
- [x] 20件のゲームデータが正しく投入されている
- [x] トップページでゲーム一覧が表示される
- [ ] ゲーム詳細ページで各ゲームの情報が表示される (チケット06で実装予定)
- [x] スコアの色分けが正しく機能している

## 関連チケット

- 前: `06_ゲーム詳細ページ実装.md`
- 次: `08_検索機能実装.md` (Phase 2)

## 参考資料

- [OpenCritic](https://opencritic.com/)
- [Supabase Database](https://supabase.com/docs/guides/database)

## 注意事項

- OpenCritic API を使用する場合は、API キーの取得と利用規約の確認が必要
- サムネイル画像のURLは実際の画像URLに置き換える必要がある
- 本番環境では既存データをクリアしないよう注意
