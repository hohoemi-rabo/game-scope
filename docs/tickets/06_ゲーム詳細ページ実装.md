# 06_ゲーム詳細ページ実装

**ステータス**: [完了]
**優先度**: 高
**Phase**: Phase 1 (MVP)

## 概要

個別ゲームの詳細情報を表示するページを実装する。動的ルーティングを使用し、ゲームIDに基づいて情報を取得・表示。

## 目的

- ゲーム詳細情報の表示
- 動的ルーティングの実装
- Twitch 連携情報の表示（Phase 1では静的、Phase 2でリアルタイム化）
- 外部リンク（OpenCritic, Steam等）の設置

## タスク一覧

### 1. 動的ルーティング設定
- [x] `app/game/[id]/` ディレクトリ作成
- [x] `page.tsx` の実装
- [x] パラメータの取得と検証

### 2. ゲーム詳細コンポーネント
- [x] GameDetailHeader（タイトル、スコア、プラットフォーム）
- [x] GameInfo（発売日、レビュー数など）
- [x] ExternalLinks（OpenCritic, Steam等へのリンク）

### 3. データフェッチング
- [x] ゲーム詳細取得関数の実装
- [x] Twitch 情報の取得
- [x] エラーハンドリング（404対応）

### 4. メタデータ生成
- [x] 動的メタデータの実装
- [ ] OGP 設定（Phase 2）

### 5. UI/UX 実装
- [x] 戻るボタンの実装
- [x] ローディング状態
- [x] エラー状態

## 実装詳細

### app/game/[id]/page.tsx

```typescript
import { notFound } from 'next/navigation'
import { getGame } from '@/lib/supabase/server'
import Container from '@/app/components/Container'
import GameDetailHeader from '@/app/components/GameDetailHeader'
import GameInfo from '@/app/components/GameInfo'
import ExternalLinks from '@/app/components/ExternalLinks'
import type { Metadata } from 'next'

interface PageProps {
  params: Promise<{ id: string }>
}

// 動的メタデータの生成
export async function generateMetadata({ params }: PageProps): Promise<Metadata> {
  const { id } = await params

  try {
    const game = await getGame(id)
    const title = game.title_ja || game.title_en

    return {
      title: title,
      description: `${title}のメタスコアやレビュー情報をチェック。${game.platforms?.join(', ')}で発売。`,
    }
  } catch (error) {
    return {
      title: 'ゲームが見つかりません',
    }
  }
}

/**
 * ゲーム詳細ページ
 */
export default async function GameDetailPage({ params }: PageProps) {
  const { id } = await params

  // ゲーム情報を取得
  let game
  try {
    game = await getGame(id)
  } catch (error) {
    console.error(`Game ${id} not found:`, error)
    notFound() // 404ページに遷移
  }

  const displayTitle = game.title_ja || game.title_en

  return (
    <Container className="py-8">
      {/* 戻るボタン */}
      <BackButton />

      {/* ヘッダー（タイトル、スコア） */}
      <GameDetailHeader
        title={displayTitle}
        metascore={game.metascore}
        platforms={game.platforms || []}
        thumbnailUrl={game.thumbnail_url}
      />

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
        {/* メイン情報 */}
        <div className="lg:col-span-2">
          <GameInfo
            releaseDate={game.release_date}
            reviewCount={game.review_count}
            titleEn={game.title_en}
          />

          {/* Twitch 情報（Phase 1では静的表示） */}
          {game.twitch_links && game.twitch_links.length > 0 && (
            <div className="mt-8">
              <h2 className="text-2xl font-bold mb-4">配信情報</h2>
              <div className="bg-gray-800/50 rounded-lg p-4 border border-gray-700">
                <p className="text-text-secondary">
                  Twitch での配信情報は Phase 2 で実装予定
                </p>
              </div>
            </div>
          )}
        </div>

        {/* サイドバー */}
        <div className="lg:col-span-1">
          <ExternalLinks
            opencriticId={game.opencritic_id}
            titleEn={game.title_en}
          />
        </div>
      </div>
    </Container>
  )
}
```

### app/components/BackButton.tsx

```typescript
'use client'

import { useRouter } from 'next/navigation'
import { ArrowLeft } from 'lucide-react' // アイコンライブラリの例

/**
 * 戻るボタンコンポーネント
 * Client Component としてブラウザ履歴を操作
 */
export default function BackButton() {
  const router = useRouter()

  return (
    <button
      onClick={() => router.back()}
      className="flex items-center gap-2 text-text-secondary hover:text-text-primary
                 transition-colors mb-6"
    >
      <span>←</span>
      <span>戻る</span>
    </button>
  )
}
```

### app/components/GameDetailHeader.tsx

```typescript
import Image from 'next/image'
import ScoreBadge from './ScoreBadge'

interface GameDetailHeaderProps {
  title: string
  metascore: number | null
  platforms: string[]
  thumbnailUrl: string | null
}

export default function GameDetailHeader({
  title,
  metascore,
  platforms,
  thumbnailUrl,
}: GameDetailHeaderProps) {
  return (
    <div className="bg-gray-800/50 rounded-lg overflow-hidden border border-gray-700">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 p-6">
        {/* サムネイル */}
        <div className="md:col-span-1">
          <div className="relative aspect-video w-full rounded-lg overflow-hidden bg-gray-900">
            {thumbnailUrl ? (
              <Image
                src={thumbnailUrl}
                alt={title}
                fill
                className="object-cover"
                priority
              />
            ) : (
              <div className="w-full h-full flex items-center justify-center text-text-secondary">
                No Image
              </div>
            )}
          </div>
        </div>

        {/* タイトルとスコア */}
        <div className="md:col-span-2 flex flex-col justify-between">
          <div>
            <h1 className="text-3xl md:text-4xl font-bold mb-4">{title}</h1>

            {/* プラットフォーム */}
            <div className="flex flex-wrap gap-2 mb-4">
              {platforms.map((platform) => (
                <span
                  key={platform}
                  className="px-3 py-1 bg-gray-700/50 rounded-lg text-sm"
                >
                  {platform}
                </span>
              ))}
            </div>
          </div>

          {/* スコア */}
          <div className="flex items-center gap-4">
            <div>
              <div className="text-sm text-text-secondary mb-1">メタスコア</div>
              <ScoreBadge score={metascore} size="lg" />
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}
```

### app/components/GameInfo.tsx

```typescript
interface GameInfoProps {
  releaseDate: string | null
  reviewCount: number | null
  titleEn: string
}

export default function GameInfo({ releaseDate, reviewCount, titleEn }: GameInfoProps) {
  // 日付のフォーマット
  const formatDate = (dateString: string | null) => {
    if (!dateString) return '未定'
    const date = new Date(dateString)
    return date.toLocaleDateString('ja-JP', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    })
  }

  return (
    <div className="bg-gray-800/50 rounded-lg p-6 border border-gray-700">
      <h2 className="text-2xl font-bold mb-4">ゲーム情報</h2>

      <dl className="space-y-4">
        <div>
          <dt className="text-text-secondary text-sm mb-1">発売日</dt>
          <dd className="text-text-primary">{formatDate(releaseDate)}</dd>
        </div>

        {reviewCount !== null && (
          <div>
            <dt className="text-text-secondary text-sm mb-1">レビュー数</dt>
            <dd className="text-text-primary">{reviewCount} 件</dd>
          </div>
        )}

        <div>
          <dt className="text-text-secondary text-sm mb-1">英語タイトル</dt>
          <dd className="text-text-primary">{titleEn}</dd>
        </div>
      </dl>
    </div>
  )
}
```

### app/components/ExternalLinks.tsx

```typescript
interface ExternalLinksProps {
  opencriticId: string | null
  titleEn: string
}

export default function ExternalLinks({ opencriticId, titleEn }: ExternalLinksProps) {
  return (
    <div className="bg-gray-800/50 rounded-lg p-6 border border-gray-700 sticky top-24">
      <h2 className="text-xl font-bold mb-4">外部リンク</h2>

      <div className="space-y-3">
        {/* OpenCritic */}
        {opencriticId && (
          <a
            href={`https://opencritic.com/game/${opencriticId}`}
            target="_blank"
            rel="noopener noreferrer"
            className="flex items-center justify-between p-3 bg-gray-700/50
                       hover:bg-gray-700 rounded-lg transition-colors"
          >
            <span>OpenCritic で見る</span>
            <span>→</span>
          </a>
        )}

        {/* Steam（タイトル検索） */}
        <a
          href={`https://store.steampowered.com/search/?term=${encodeURIComponent(titleEn)}`}
          target="_blank"
          rel="noopener noreferrer"
          className="flex items-center justify-between p-3 bg-gray-700/50
                     hover:bg-gray-700 rounded-lg transition-colors"
        >
          <span>Steam で検索</span>
          <span>→</span>
        </a>
      </div>
    </div>
  )
}
```

### app/game/[id]/not-found.tsx

```typescript
import Container from '@/app/components/Container'
import Link from 'next/link'

/**
 * ゲームが見つからない場合の404ページ
 */
export default function NotFound() {
  return (
    <Container className="py-8">
      <div className="flex flex-col items-center justify-center min-h-[400px] text-center">
        <h1 className="text-4xl font-bold mb-4">ゲームが見つかりません</h1>
        <p className="text-text-secondary mb-8">
          指定されたゲームは存在しないか、削除された可能性があります。
        </p>
        <Link
          href="/"
          className="px-6 py-3 bg-accent hover:bg-accent/80
                     text-white rounded-lg transition-colors"
        >
          トップページに戻る
        </Link>
      </div>
    </Container>
  )
}
```

## 完了条件

- [x] ゲーム詳細ページが正しく表示される
- [x] 動的ルーティングが機能している
- [x] スコアバッジが正しく表示される
- [x] 外部リンクが正しく動作する
- [x] 404ページが適切に表示される
- [x] 戻るボタンが機能する
- [x] メタデータが動的に生成される

## 関連チケット

- 前: `05_トップページ実装.md`
- 次: `07_初期データ投入.md`

## 参考資料

- [Next.js Dynamic Routes](https://nextjs.org/docs/app/building-your-application/routing/dynamic-routes)
- [Next.js generateMetadata](https://nextjs.org/docs/app/api-reference/functions/generate-metadata)
- [Next.js notFound](https://nextjs.org/docs/app/api-reference/functions/not-found)
