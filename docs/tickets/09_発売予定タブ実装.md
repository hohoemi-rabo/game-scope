# 09_発売予定タブ実装

**ステータス**: [未着手]
**優先度**: 中
**Phase**: Phase 2 (UX拡張)

## 概要

国内外のゲーム発売予定情報を表示するページを実装する。RSSフィードから情報を取得し、発売日順に表示。

## 目的

- 発売予定ゲームの一覧表示
- RSS フィードからのデータ取得
- 発売日順のソート
- 情報ソースの明示

## タスク一覧

### 1. RSSフィード取得機能
- [ ] RSS パーサーライブラリの選定とインストール
- [ ] RSS 取得関数の実装（4Gamer, 任天堂, PS Blog）
- [ ] データ正規化の実装

### 2. API Route の実装
- [ ] `/api/releases` エンドポイント作成
- [ ] キャッシング戦略の実装
- [ ] エラーハンドリング

### 3. UI コンポーネント
- [ ] ReleaseCard コンポーネント
- [ ] ReleaseList コンポーネント
- [ ] プラットフォームフィルター

### 4. ページ実装
- [ ] `/releases` ページの作成
- [ ] データフェッチングの実装
- [ ] ローディング・エラー状態

## 実装詳細

### lib/api/rss.ts

```typescript
import Parser from 'rss-parser'

const parser = new Parser()

interface RSSFeedSource {
  name: string
  url: string
  platform: string
}

/**
 * RSS フィードソース定義
 */
const RSS_SOURCES: RSSFeedSource[] = [
  {
    name: '4Gamer',
    url: 'https://www.4gamer.net/rss/news.xml',
    platform: 'Multi',
  },
  {
    name: 'Nintendo',
    url: 'https://www.nintendo.co.jp/software/xml/index.xml',
    platform: 'Nintendo Switch',
  },
  {
    name: 'PlayStation Blog',
    url: 'https://blog.ja.playstation.com/feed/',
    platform: 'PlayStation',
  },
]

interface ReleaseItem {
  title: string
  link: string
  pubDate: string
  source: string
  platform: string
  description?: string
}

/**
 * RSS フィードから発売予定情報を取得
 */
export async function fetchReleases(): Promise<ReleaseItem[]> {
  const allReleases: ReleaseItem[] = []

  for (const source of RSS_SOURCES) {
    try {
      const feed = await parser.parseURL(source.url)

      const releases = feed.items
        .filter((item) => {
          // 発売予定に関連するキーワードでフィルタリング
          const keywords = ['発売', '配信', 'リリース', '予定']
          const text = `${item.title} ${item.contentSnippet || ''}`
          return keywords.some((keyword) => text.includes(keyword))
        })
        .map((item) => ({
          title: item.title || '',
          link: item.link || '',
          pubDate: item.pubDate || item.isoDate || '',
          source: source.name,
          platform: source.platform,
          description: item.contentSnippet,
        }))

      allReleases.push(...releases)
    } catch (error) {
      console.error(`Failed to fetch RSS from ${source.name}:`, error)
      // エラーがあっても他のソースは継続
    }
  }

  // 日付順にソート（新しい順）
  return allReleases.sort((a, b) => {
    return new Date(b.pubDate).getTime() - new Date(a.pubDate).getTime()
  })
}
```

### app/api/releases/route.ts

```typescript
import { NextResponse } from 'next/server'
import { fetchReleases } from '@/lib/api/rss'

/**
 * 発売予定情報取得 API
 * 1時間キャッシュ
 */
export async function GET() {
  try {
    const releases = await fetchReleases()

    return NextResponse.json(
      { releases, count: releases.length },
      {
        headers: {
          'Cache-Control': 'public, s-maxage=3600, stale-while-revalidate=7200',
        },
      }
    )
  } catch (error) {
    console.error('Failed to fetch releases:', error)
    return NextResponse.json(
      { error: 'Failed to fetch releases' },
      { status: 500 }
    )
  }
}
```

### app/components/ReleaseCard.tsx

```typescript
interface ReleaseCardProps {
  title: string
  link: string
  pubDate: string
  source: string
  platform: string
  description?: string
}

/**
 * 発売予定カードコンポーネント
 */
export default function ReleaseCard({
  title,
  link,
  pubDate,
  source,
  platform,
  description,
}: ReleaseCardProps) {
  // 日付のフォーマット
  const formatDate = (dateString: string) => {
    const date = new Date(dateString)
    return date.toLocaleDateString('ja-JP', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    })
  }

  return (
    <article className="bg-gray-800/50 rounded-lg p-6 border border-gray-700
                        hover:border-accent/50 transition-colors">
      {/* タイトル */}
      <h3 className="text-lg font-bold text-text-primary mb-2">
        <a
          href={link}
          target="_blank"
          rel="noopener noreferrer"
          className="hover:text-accent transition-colors"
        >
          {title}
        </a>
      </h3>

      {/* 説明 */}
      {description && (
        <p className="text-text-secondary text-sm mb-4 line-clamp-2">
          {description}
        </p>
      )}

      {/* メタ情報 */}
      <div className="flex items-center justify-between text-sm">
        <div className="flex items-center gap-3">
          {/* プラットフォーム */}
          <span className="px-2 py-1 bg-gray-700/50 rounded text-xs">
            {platform}
          </span>

          {/* ソース */}
          <span className="text-text-secondary text-xs">
            {source}
          </span>
        </div>

        {/* 公開日 */}
        <time className="text-text-secondary text-xs">
          {formatDate(pubDate)}
        </time>
      </div>
    </article>
  )
}
```

### app/releases/page.tsx

```typescript
'use client'

import { useState, useEffect } from 'react'
import useSWR from 'swr'
import Container from '../components/Container'
import ReleaseCard from '../components/ReleaseCard'
import LoadingSpinner from '../components/LoadingSpinner'

const fetcher = (url: string) => fetch(url).then((r) => r.json())

/**
 * 発売予定ページ
 * Client Component としてリアルタイム更新
 */
export default function ReleasesPage() {
  const [selectedPlatform, setSelectedPlatform] = useState<string>('All')

  const { data, error, isLoading } = useSWR('/api/releases', fetcher, {
    revalidateOnFocus: false,
    revalidateOnReconnect: false,
  })

  if (error) {
    return (
      <Container className="py-8">
        <div className="text-center text-danger">
          <p>発売予定情報の取得に失敗しました</p>
        </div>
      </Container>
    )
  }

  if (isLoading) {
    return (
      <Container className="py-8">
        <div className="flex justify-center">
          <LoadingSpinner size="lg" />
        </div>
      </Container>
    )
  }

  const releases = data?.releases || []

  // プラットフォームでフィルタリング
  const filteredReleases =
    selectedPlatform === 'All'
      ? releases
      : releases.filter((r: any) => r.platform === selectedPlatform)

  // プラットフォーム一覧を取得
  const platforms = ['All', ...new Set(releases.map((r: any) => r.platform))]

  return (
    <Container className="py-8">
      <header className="mb-8">
        <h1 className="text-4xl font-bold mb-2">発売予定</h1>
        <p className="text-text-secondary">
          国内外のゲーム発売予定情報を掲載しています
        </p>
      </header>

      {/* プラットフォームフィルター */}
      <div className="flex flex-wrap gap-2 mb-6">
        {platforms.map((platform) => (
          <button
            key={platform}
            onClick={() => setSelectedPlatform(platform)}
            className={`px-4 py-2 rounded-lg transition-colors
              ${selectedPlatform === platform
                ? 'bg-accent text-white'
                : 'bg-gray-800 text-text-secondary hover:bg-gray-700'
              }`}
          >
            {platform}
          </button>
        ))}
      </div>

      {/* 発売予定一覧 */}
      <div className="space-y-4">
        {filteredReleases.length === 0 ? (
          <div className="text-center text-text-secondary py-12">
            発売予定情報が見つかりませんでした
          </div>
        ) : (
          filteredReleases.map((release: any, index: number) => (
            <ReleaseCard key={`${release.link}-${index}`} {...release} />
          ))
        )}
      </div>
    </Container>
  )
}
```

### 必要なパッケージ

```bash
npm install rss-parser
```

### ヘッダーにリンク追加

```typescript
// app/components/Header.tsx に追加
<Link
  href="/releases"
  className="text-text-secondary hover:text-text-primary transition-colors"
>
  発売予定
</Link>
```

## 完了条件

- [ ] RSS フィードからデータを取得できる
- [ ] 発売予定ページが表示される
- [ ] プラットフォームフィルターが機能する
- [ ] 情報ソースが明示されている
- [ ] 外部リンクが正しく動作する
- [ ] キャッシングが機能している

## 関連チケット

- 前: `08_検索機能実装.md`
- 次: `10_自動更新システム.md` (Phase 3)

## 参考資料

- [rss-parser](https://github.com/rbren/rss-parser)
- [Next.js API Routes](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)
- [SWR](https://swr.vercel.app/)

## 注意事項

- RSS フィードの取得には時間がかかるため、適切なキャッシング戦略が必要
- 外部サイトの RSS フィード仕様変更に注意
- CORS エラーを回避するため、API Route 経由でデータ取得
