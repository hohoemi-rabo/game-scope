# ãƒã‚±ãƒƒãƒˆ #19: ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªç™»éŒ²æ©Ÿèƒ½

## ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: [å®Œäº†]

## æ¦‚è¦

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚²ãƒ¼ãƒ ã‚’ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã«ç™»éŒ²ã™ã‚‹ãŸã‚ã®ãƒ¢ãƒ¼ãƒ€ãƒ«UIã¨Server Actionã‚’å®Ÿè£…ã™ã‚‹ã€‚

## èƒŒæ™¯

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè³¼å…¥é‡‘é¡ã€ãƒ—ãƒ¬ã‚¤æ™‚é–“ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å…¥åŠ›ã—ã¦ã‚²ãƒ¼ãƒ ã‚’ç™»éŒ²
- ç™»éŒ²æ–¹æ³•ã¯2ç¨®é¡: äººæ°—ã‚²ãƒ¼ãƒ ï¼ˆTop60ï¼‰ã‹ã‚‰é¸ã¶ / æ¤œç´¢ã—ã¦æ¢ã™
- ç™»éŒ²å¾Œã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«åæ˜ ã•ã‚Œã‚‹

## ä½œæ¥­å†…å®¹

### 1. ã‚²ãƒ¼ãƒ ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«

- [x] ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ
- [x] Step 1: ç™»éŒ²æ–¹æ³•é¸æŠ
- [x] Step 2a: äººæ°—ã‚²ãƒ¼ãƒ ã‹ã‚‰é¸ã¶
- [x] Step 2b: æ¤œç´¢ã—ã¦æ¢ã™
- [x] Step 3: è©³ç´°å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 

### 2. Server Action

- [x] `createPortfolioEntry` - ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªç™»éŒ²
- [x] ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
- [x] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 3. å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 

- [x] è³¼å…¥é‡‘é¡å…¥åŠ›
- [x] ã‚µãƒ–ã‚¹ã‚¯/ç„¡æ–™ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
- [x] ãƒ—ãƒ¬ã‚¤æ™‚é–“å…¥åŠ›
- [x] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠ

## æŠ€è¡“ä»•æ§˜

### ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

```
src/app/components/portfolio/
â”œâ”€â”€ AddGameModal.tsx          # ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«
â”œâ”€â”€ GameSelectStep.tsx        # Step 1: ç™»éŒ²æ–¹æ³•é¸æŠ
â”œâ”€â”€ PopularGamesStep.tsx      # Step 2a: äººæ°—ã‚²ãƒ¼ãƒ ãƒªã‚¹ãƒˆ
â”œâ”€â”€ SearchGamesStep.tsx       # Step 2b: æ¤œç´¢ç”»é¢
â”œâ”€â”€ GameDetailsForm.tsx       # Step 3: è©³ç´°å…¥åŠ›
â””â”€â”€ StatusSelect.tsx          # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
```

### Step 1: ç™»éŒ²æ–¹æ³•é¸æŠ

```typescript
// src/app/components/portfolio/GameSelectStep.tsx
'use client'

interface GameSelectStepProps {
  onSelectPopular: () => void
  onSelectSearch: () => void
}

export default function GameSelectStep({ onSelectPopular, onSelectSearch }: GameSelectStepProps) {
  return (
    <div className="grid grid-cols-2 gap-4">
      <button
        onClick={onSelectPopular}
        className="p-6 bg-gray-800 rounded-xl border border-gray-700
                   hover:border-accent transition-colors text-left"
      >
        <span className="text-3xl mb-3 block">ğŸ†</span>
        <h3 className="font-bold text-text-primary mb-1">äººæ°—ã‚²ãƒ¼ãƒ ã‹ã‚‰é¸ã¶</h3>
        <p className="text-sm text-text-secondary">Top60ã‹ã‚‰ã™ãã«é¸ã¹ã‚‹</p>
      </button>

      <button
        onClick={onSelectSearch}
        className="p-6 bg-gray-800 rounded-xl border border-gray-700
                   hover:border-accent transition-colors text-left"
      >
        <span className="text-3xl mb-3 block">ğŸ”</span>
        <h3 className="font-bold text-text-primary mb-1">æ¤œç´¢ã—ã¦æ¢ã™</h3>
        <p className="text-sm text-text-secondary">RAWG APIã§è‡ªç”±ã«æ¤œç´¢</p>
      </button>
    </div>
  )
}
```

### Step 3: è©³ç´°å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 

```typescript
// src/app/components/portfolio/GameDetailsForm.tsx
'use client'

import { useState } from 'react'
import { createPortfolioEntry } from '@/app/actions/portfolio'

interface GameDetailsFormProps {
  gameId: string
  gameName: string
  gameThumbnail: string | null
  onSuccess: () => void
  onCancel: () => void
}

type GameStatus = 'playing' | 'completed' | 'dropped' | 'backlog'

export default function GameDetailsForm({
  gameId,
  gameName,
  gameThumbnail,
  onSuccess,
  onCancel,
}: GameDetailsFormProps) {
  const [purchasePrice, setPurchasePrice] = useState('')
  const [playTimeHours, setPlayTimeHours] = useState('')
  const [isSubscription, setIsSubscription] = useState(false)
  const [status, setStatus] = useState<GameStatus>('backlog')
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [error, setError] = useState<string | null>(null)

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsSubmitting(true)
    setError(null)

    try {
      const result = await createPortfolioEntry({
        gameId,
        purchasePrice: isSubscription ? 0 : parseInt(purchasePrice) || 0,
        playTimeMinutes: Math.round((parseFloat(playTimeHours) || 0) * 60),
        isSubscription,
        status,
      })

      if (result.error) {
        setError(result.error)
      } else {
        onSuccess()
      }
    } catch (err) {
      setError('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ')
    } finally {
      setIsSubmitting(false)
    }
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      {/* ã‚²ãƒ¼ãƒ æƒ…å ±è¡¨ç¤º */}
      <div className="flex items-center gap-4">
        {gameThumbnail && (
          <img src={gameThumbnail} alt={gameName} className="w-20 h-12 object-cover rounded" />
        )}
        <h3 className="font-bold text-text-primary">{gameName}</h3>
      </div>

      {/* è³¼å…¥é‡‘é¡ */}
      <div>
        <label className="block text-sm font-medium text-text-secondary mb-2">
          è³¼å…¥é‡‘é¡
        </label>
        <div className="flex items-center gap-2">
          <span className="text-text-secondary">Â¥</span>
          <input
            type="number"
            value={purchasePrice}
            onChange={(e) => setPurchasePrice(e.target.value)}
            disabled={isSubscription}
            placeholder="9000"
            className="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-4 py-2
                       text-text-primary focus:border-accent focus:outline-none
                       disabled:opacity-50"
          />
        </div>
        <label className="flex items-center gap-2 mt-2">
          <input
            type="checkbox"
            checked={isSubscription}
            onChange={(e) => setIsSubscription(e.target.checked)}
            className="rounded border-gray-700"
          />
          <span className="text-sm text-text-secondary">ã‚µãƒ–ã‚¹ã‚¯/ç„¡æ–™ã§å…¥æ‰‹</span>
        </label>
      </div>

      {/* ãƒ—ãƒ¬ã‚¤æ™‚é–“ */}
      <div>
        <label className="block text-sm font-medium text-text-secondary mb-2">
          ãƒ—ãƒ¬ã‚¤æ™‚é–“
        </label>
        <div className="flex items-center gap-2">
          <input
            type="number"
            step="0.5"
            value={playTimeHours}
            onChange={(e) => setPlayTimeHours(e.target.value)}
            placeholder="120"
            className="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-4 py-2
                       text-text-primary focus:border-accent focus:outline-none"
          />
          <span className="text-text-secondary">æ™‚é–“</span>
        </div>
      </div>

      {/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */}
      <div>
        <label className="block text-sm font-medium text-text-secondary mb-2">
          ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
        </label>
        <select
          value={status}
          onChange={(e) => setStatus(e.target.value as GameStatus)}
          className="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2
                     text-text-primary focus:border-accent focus:outline-none"
        >
          <option value="playing">ğŸ® Playingï¼ˆãƒ—ãƒ¬ã‚¤ä¸­ï¼‰</option>
          <option value="completed">âœ… Completedï¼ˆã‚¯ãƒªã‚¢æ¸ˆã¿ï¼‰</option>
          <option value="dropped">âŒ Droppedï¼ˆã‚„ã‚ãŸï¼‰</option>
          <option value="backlog">ğŸ“š Backlogï¼ˆç©ã¿ã‚²ãƒ¼ï¼‰</option>
        </select>
      </div>

      {/* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */}
      {error && (
        <div className="text-danger text-sm">{error}</div>
      )}

      {/* ãƒœã‚¿ãƒ³ */}
      <div className="flex gap-4">
        <button
          type="button"
          onClick={onCancel}
          className="flex-1 px-4 py-2 border border-gray-700 rounded-lg
                     text-text-secondary hover:bg-gray-800 transition-colors"
        >
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button
          type="submit"
          disabled={isSubmitting}
          className="flex-1 px-4 py-2 bg-accent text-white rounded-lg
                     hover:bg-accent/80 transition-colors disabled:opacity-50"
        >
          {isSubmitting ? 'ç™»éŒ²ä¸­...' : 'ç™»éŒ²ã™ã‚‹'}
        </button>
      </div>
    </form>
  )
}
```

### Server Action

```typescript
// src/app/actions/portfolio.ts
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'

interface CreatePortfolioInput {
  gameId: string
  purchasePrice: number
  playTimeMinutes: number
  isSubscription: boolean
  status: 'playing' | 'completed' | 'dropped' | 'backlog'
}

export async function createPortfolioEntry(input: CreatePortfolioInput) {
  const supabase = createClient()

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ç¢ºèª
  const { data: { user }, error: authError } = await supabase.auth.getUser()

  if (authError || !user) {
    return { error: 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™' }
  }

  // æ—¢å­˜ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã®ç¢ºèª
  const { data: existing } = await supabase
    .from('user_portfolios')
    .select('id')
    .eq('user_id', user.id)
    .eq('game_id', input.gameId)
    .single()

  if (existing) {
    return { error: 'ã“ã®ã‚²ãƒ¼ãƒ ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™' }
  }

  // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã«è¿½åŠ 
  const { data, error } = await supabase
    .from('user_portfolios')
    .insert({
      user_id: user.id,
      game_id: input.gameId,
      purchase_price: input.purchasePrice,
      play_time_minutes: input.playTimeMinutes,
      is_subscription: input.isSubscription,
      status: input.status,
    })
    .select('id')
    .single()

  if (error) {
    console.error('Portfolio creation error:', error)
    return { error: 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ' }
  }

  revalidatePath('/dashboard')

  return { success: true, id: data.id }
}
```

### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å®šç¾©

| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹  | ã‚¢ã‚¤ã‚³ãƒ³ | è¡¨ç¤ºå     | ç”¨é€”                     |
| ----------- | -------- | ---------- | ------------------------ |
| `playing`   | ğŸ®       | Playing    | ç¾åœ¨ãƒ—ãƒ¬ã‚¤ä¸­             |
| `completed` | âœ…       | Completed  | ã‚¯ãƒªã‚¢æ¸ˆã¿               |
| `dropped`   | âŒ       | Dropped    | é€”ä¸­ã§ã‚„ã‚ãŸ             |
| `backlog`   | ğŸ“š       | Backlog    | ç©ã¿ã‚²ãƒ¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰   |

## ä¾å­˜é–¢ä¿‚

- #16 DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆuser_portfoliosãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
- #17 èªè¨¼UIå®Ÿè£…
- #18 RAWGã‚²ãƒ¼ãƒ æ¤œç´¢API

## å—ã‘å…¥ã‚Œæ¡ä»¶

- [x] ã€Œ+ ã‚²ãƒ¼ãƒ ã‚’ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã
- [x] äººæ°—ã‚²ãƒ¼ãƒ ã‹ã‚‰é¸æŠã§ãã‚‹
- [x] æ¤œç´¢ã—ã¦ã‚²ãƒ¼ãƒ ã‚’é¸æŠã§ãã‚‹
- [x] è³¼å…¥é‡‘é¡ã€ãƒ—ãƒ¬ã‚¤æ™‚é–“ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å…¥åŠ›ã§ãã‚‹
- [x] ã‚µãƒ–ã‚¹ã‚¯/ç„¡æ–™ãƒã‚§ãƒƒã‚¯ã§é‡‘é¡å…¥åŠ›ãŒç„¡åŠ¹åŒ–ã•ã‚Œã‚‹
- [x] ç™»éŒ²å¾Œã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«åæ˜ ã•ã‚Œã‚‹
- [x] åŒã˜ã‚²ãƒ¼ãƒ ã®é‡è¤‡ç™»éŒ²ãŒé˜²æ­¢ã•ã‚Œã‚‹
- [x] æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ç™»éŒ²ã§ããªã„ï¼ˆã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼‰

## ãƒ‡ã‚¶ã‚¤ãƒ³ä»•æ§˜

- ãƒ¢ãƒ¼ãƒ€ãƒ«: ä¸­å¤®è¡¨ç¤ºã€èƒŒæ™¯æš—è»¢
- ã‚¹ãƒ†ãƒƒãƒ—é–“ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä»»æ„ï¼‰
- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ : ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã«çµ±ä¸€
- ãƒœã‚¿ãƒ³: ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ä½¿ç”¨

## é–¢é€£ãƒã‚±ãƒƒãƒˆ

- #18 RAWGã‚²ãƒ¼ãƒ æ¤œç´¢API
- #20 ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰UI
