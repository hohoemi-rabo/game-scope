# 10_自動更新システム

**ステータス**: [未着手]
**優先度**: 低
**Phase**: Phase 3 (運用自動化)

## 概要

Supabase の定期実行機能を使用して、ゲーム情報を自動的に更新するシステムを構築する。

## 目的

- 日次での自動データ更新
- OpenCritic API からの最新スコア取得
- RSS フィードからの発売予定情報更新
- エラーハンドリングとログ記録

## タスク一覧

### 1. Supabase Edge Functions 実装
- [ ] 更新用 Edge Function の作成
- [ ] OpenCritic API 連携
- [ ] データベース更新ロジック

### 2. Supabase Cron Jobs 設定
- [ ] 日次実行スケジュールの設定
- [ ] 実行時間の最適化

### 3. エラーハンドリング
- [ ] リトライ機構の実装
- [ ] エラーログの記録
- [ ] アラート通知（オプション）

### 4. 監視とログ
- [ ] 実行ログの記録
- [ ] 成功/失敗の統計
- [ ] ダッシュボードでの確認

## 実装詳細

### supabase/functions/update-games/index.ts

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const supabaseUrl = Deno.env.get('SUPABASE_URL')!
const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
const opencriticApiKey = Deno.env.get('OPENCRITIC_API_KEY')

/**
 * OpenCritic API からゲーム情報を取得
 */
async function fetchGameFromOpenCritic(opencriticId: string) {
  const response = await fetch(
    `https://api.opencritic.com/api/game/${opencriticId}`,
    {
      headers: {
        'X-API-Key': opencriticApiKey || '',
      },
    }
  )

  if (!response.ok) {
    throw new Error(`OpenCritic API error: ${response.status}`)
  }

  return await response.json()
}

/**
 * ゲーム情報を更新
 */
async function updateGameData(supabase: any, game: any) {
  try {
    // OpenCritic から最新情報を取得
    const opencriticData = await fetchGameFromOpenCritic(game.opencritic_id)

    // データベースを更新
    const { error } = await supabase
      .from('games')
      .update({
        metascore: opencriticData.topCriticScore,
        review_count: opencriticData.numReviews,
        updated_at: new Date().toISOString(),
      })
      .eq('id', game.id)

    if (error) throw error

    return { success: true, gameId: game.id }
  } catch (error) {
    console.error(`Failed to update game ${game.id}:`, error)
    return { success: false, gameId: game.id, error: error.message }
  }
}

/**
 * 実行ログを記録
 */
async function logOperation(supabase: any, status: string, details: any) {
  await supabase.from('operation_logs').insert({
    operation_type: 'auto_update',
    status,
    details,
  })
}

/**
 * メイン処理
 */
serve(async (req) => {
  try {
    const supabase = createClient(supabaseUrl, supabaseServiceKey)

    console.log('Starting automatic game data update...')

    // OpenCritic ID を持つゲームを取得
    const { data: games, error: fetchError } = await supabase
      .from('games')
      .select('id, opencritic_id, title_en')
      .not('opencritic_id', 'is', null)

    if (fetchError) throw fetchError

    console.log(`Found ${games.length} games to update`)

    // 各ゲームを更新（並列処理）
    const results = await Promise.allSettled(
      games.map((game) => updateGameData(supabase, game))
    )

    // 結果を集計
    const successCount = results.filter(
      (r) => r.status === 'fulfilled' && r.value.success
    ).length
    const failureCount = results.length - successCount

    const summary = {
      total: games.length,
      success: successCount,
      failure: failureCount,
      timestamp: new Date().toISOString(),
    }

    console.log('Update completed:', summary)

    // ログを記録
    await logOperation(supabase, 'success', summary)

    return new Response(JSON.stringify(summary), {
      headers: { 'Content-Type': 'application/json' },
      status: 200,
    })
  } catch (error) {
    console.error('Update failed:', error)

    // エラーログを記録
    try {
      const supabase = createClient(supabaseUrl, supabaseServiceKey)
      await logOperation(supabase, 'error', {
        error: error.message,
        timestamp: new Date().toISOString(),
      })
    } catch (logError) {
      console.error('Failed to log error:', logError)
    }

    return new Response(
      JSON.stringify({ error: error.message }),
      {
        headers: { 'Content-Type': 'application/json' },
        status: 500,
      }
    )
  }
})
```

### Supabase Cron Job 設定

SQL で Cron Job を設定:

```sql
-- pg_cron 拡張機能を有効化
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- 毎日午前3時（JST）に実行
-- UTC 18:00 = JST 03:00
SELECT cron.schedule(
  'update-game-data',
  '0 18 * * *',
  $$
  SELECT
    net.http_post(
      url := 'https://your-project.supabase.co/functions/v1/update-games',
      headers := '{"Content-Type": "application/json", "Authorization": "Bearer YOUR_ANON_KEY"}'::jsonb
    ) as request_id;
  $$
);

-- Cron Job の確認
SELECT * FROM cron.job;

-- Cron Job の実行履歴確認
SELECT * FROM cron.job_run_details ORDER BY start_time DESC LIMIT 10;
```

### 手動実行用スクリプト

```bash
#!/bin/bash
# scripts/trigger-update.sh

# Supabase Edge Function を手動で実行
curl -X POST \
  'https://your-project.supabase.co/functions/v1/update-games' \
  -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
  -H "Content-Type: application/json"
```

### モニタリングダッシュボード用クエリ

```sql
-- 最近の実行ログを取得
SELECT
  operation_type,
  status,
  details,
  created_at
FROM operation_logs
WHERE operation_type = 'auto_update'
ORDER BY created_at DESC
LIMIT 30;

-- 成功率の計算
SELECT
  DATE(created_at) as date,
  COUNT(*) as total_runs,
  SUM(CASE WHEN status = 'success' THEN 1 ELSE 0 END) as successful_runs,
  ROUND(
    100.0 * SUM(CASE WHEN status = 'success' THEN 1 ELSE 0 END) / COUNT(*),
    2
  ) as success_rate
FROM operation_logs
WHERE operation_type = 'auto_update'
  AND created_at >= NOW() - INTERVAL '30 days'
GROUP BY DATE(created_at)
ORDER BY date DESC;
```

### エラー通知（Discord Webhook の例）

```typescript
async function sendErrorNotification(error: any) {
  const webhookUrl = Deno.env.get('DISCORD_WEBHOOK_URL')
  if (!webhookUrl) return

  const message = {
    content: '⚠️ GameScope 自動更新エラー',
    embeds: [
      {
        title: 'エラー詳細',
        description: error.message,
        color: 0xff5252, // 赤色
        timestamp: new Date().toISOString(),
      },
    ],
  }

  await fetch(webhookUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(message),
  })
}
```

## 完了条件

- [ ] Edge Function が正常にデプロイされている
- [ ] Cron Job が設定されている
- [ ] 手動実行で正常に動作する
- [ ] エラーログが正しく記録される
- [ ] 実行履歴が確認できる

## 関連チケット

- 前: `09_発売予定タブ実装.md`
- 関連: `01_データベーススキーマ作成.md`（operation_logs テーブル）

## 参考資料

- [Supabase Edge Functions](https://supabase.com/docs/guides/functions)
- [Supabase Cron Jobs](https://supabase.com/docs/guides/database/extensions/pg_cron)
- [OpenCritic API Documentation](https://opencritic.com/api)

## 注意事項

- OpenCritic API のレート制限に注意
- 大量のリクエストを避けるため、バッチ処理と適切な待機時間を設定
- 本番環境で実行する前に、ステージング環境で十分にテスト
- API キーは環境変数で管理し、ハードコードしない
