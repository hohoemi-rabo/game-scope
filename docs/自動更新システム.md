# 自動更新システム

GameScopeのゲームデータを自動的に同期するシステムです。

## 概要

- **実行頻度**: 毎日午前3時（JST）
- **Edge Function**: `sync-games`
- **処理内容**:
  1. OpenCritic APIからトップ60ゲーム取得（3回バッチ、skip=0,20,40）
  2. RAWGで各ゲームの説明文とジャンルを補完
  3. 既存データを削除して全件再投入

## APIリクエスト数

| API | リクエスト数 | 月間使用量 | 無料枠 |
|-----|------------|----------|--------|
| OpenCritic | 3回/日 | 90回/月 | 100回/月 |
| RAWG | 120回/日 | 3,600回/月 | 20,000回/月 |

✅ すべて無料枠内で運用可能

## 手動実行

開発時やデバッグ時に手動で同期を実行できます。

### スクリプトを使う方法

```bash
./scripts/trigger-sync.sh
```

### curlで直接実行する方法

```bash
curl -X POST \
  'https://vhuhazlgqmuihejpiuyy.supabase.co/functions/v1/sync-games' \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json"
```

## 実行ログの確認

### Supabase Dashboardで確認

1. Supabase Dashboard → Edge Functions → sync-games
2. Logs タブで実行ログを確認

### SQLで確認

```sql
-- 最新10件の実行ログ
SELECT
  operation_type,
  status,
  details,
  created_at
FROM operation_logs
WHERE operation_type = 'auto_sync'
ORDER BY created_at DESC
LIMIT 10;

-- 成功率の計算（過去30日間）
SELECT
  DATE(created_at) as date,
  COUNT(*) as total_runs,
  SUM(CASE WHEN status = 'success' THEN 1 ELSE 0 END) as successful_runs,
  ROUND(
    100.0 * SUM(CASE WHEN status = 'success' THEN 1 ELSE 0 END) / COUNT(*),
    2
  ) as success_rate_percent
FROM operation_logs
WHERE operation_type = 'auto_sync'
  AND created_at >= NOW() - INTERVAL '30 days'
GROUP BY DATE(created_at)
ORDER BY date DESC;
```

## Cron Jobの管理

### スケジュール確認

```sql
SELECT
  jobid,
  jobname,
  schedule,
  active,
  nodename
FROM cron.job
ORDER BY jobid DESC;
```

### 実行履歴確認

```sql
SELECT
  runid,
  jobid,
  job_pid,
  database,
  username,
  command,
  status,
  return_message,
  start_time,
  end_time
FROM cron.job_run_details
ORDER BY start_time DESC
LIMIT 10;
```

### スケジュールの削除

```sql
SELECT cron.unschedule('sync-games-daily');
```

### スケジュールの再設定

```sql
SELECT cron.schedule(
  'sync-games-daily',
  '0 18 * * *',  -- UTC 18:00 = JST 03:00
  $$
  SELECT net.http_post(
    url := 'https://vhuhazlgqmuihejpiuyy.supabase.co/functions/v1/sync-games',
    body := '{}'::jsonb,
    params := '{}'::jsonb,
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer YOUR_ANON_KEY'
    ),
    timeout_milliseconds := 90000
  ) as request_id;
  $$
);
```

**重要**: `net.http_post()` 関数は以下のパラメータをすべて指定する必要があります：
- `url`: Edge FunctionのURL
- `body`: リクエストボディ（空の場合は `'{}'::jsonb`）
- `params`: URLパラメータ（空の場合は `'{}'::jsonb`）
- `headers`: HTTPヘッダー（認証トークンを含む）
- `timeout_milliseconds`: タイムアウト時間（90秒推奨）

## 環境変数

Edge Functionで使用する環境変数はSupabase Dashboardで設定済みです：

- `SUPABASE_URL` - 自動設定
- `SUPABASE_SERVICE_ROLE_KEY` - 自動設定
- `OPENCRITIC_API_KEY` - RapidAPI経由のOpenCriticキー
- `RAWG_API_KEY` - RAWG APIキー

## トラブルシューティング

### 同期が失敗する場合

1. **Edge Functionログを確認**
   - Supabase Dashboard → Edge Functions → sync-games → Logs

2. **operation_logsテーブルを確認**
   ```sql
   SELECT * FROM operation_logs
   WHERE status = 'error'
   ORDER BY created_at DESC
   LIMIT 5;
   ```

3. **APIキーの有効性を確認**
   - OpenCritic: RapidAPIダッシュボードで確認
   - RAWG: https://rawg.io/settings/api

### Cron Jobが実行されない場合

1. **ジョブが有効か確認**
   ```sql
   SELECT * FROM cron.job WHERE jobname = 'sync-games-daily';
   ```

2. **実行履歴を確認**
   ```sql
   SELECT * FROM cron.job_run_details
   WHERE jobid = (SELECT jobid FROM cron.job WHERE jobname = 'sync-games-daily')
   ORDER BY start_time DESC
   LIMIT 5;
   ```

3. **pg_cron拡張機能が有効か確認**
   ```sql
   SELECT * FROM pg_extension WHERE extname = 'pg_cron';
   ```

4. **"schema net does not exist" エラーが出る場合**

   pg_net拡張機能が正しくインストールされているか確認：
   ```sql
   SELECT extname, extversion, nspname
   FROM pg_extension
   JOIN pg_namespace ON pg_extension.extnamespace = pg_namespace.oid
   WHERE extname = 'pg_net';
   ```

   インストールされていない場合：
   ```sql
   CREATE EXTENSION IF NOT EXISTS pg_net SCHEMA extensions;
   ```

   Cron Jobを再作成（上記「スケジュールの再設定」参照）

## メンテナンス

### データの整合性チェック

```sql
-- ゲームデータの件数確認
SELECT COUNT(*) as total_games FROM games;

-- 説明文とジャンルの充足率
SELECT
  COUNT(*) as total,
  SUM(CASE WHEN description_en IS NOT NULL THEN 1 ELSE 0 END) as has_description,
  SUM(CASE WHEN genres IS NOT NULL THEN 1 ELSE 0 END) as has_genres,
  ROUND(100.0 * SUM(CASE WHEN description_en IS NOT NULL THEN 1 ELSE 0 END) / COUNT(*), 2) as description_rate,
  ROUND(100.0 * SUM(CASE WHEN genres IS NOT NULL THEN 1 ELSE 0 END) / COUNT(*), 2) as genre_rate
FROM games;
```

## 関連ファイル

- **Edge Function**: `supabase/functions/sync-games/index.ts`
- **手動実行スクリプト**: `scripts/trigger-sync.sh`
- **ローカル同期スクリプト**: `scripts/sync-hybrid-to-supabase.ts`
